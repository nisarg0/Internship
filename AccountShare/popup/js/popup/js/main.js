!function(){"use strict";const t={render:function(t,n){log("[Template] Rendering",t," with data",n);let r=this.get(t);p("app").innerHTML=r.render(n||{}),e.attach(t)},get:function(t){let e="js-template-"+t,n=p(e);if(!n)throw new Error("Whoops! template "+e+" does not exist");return new _t(n.innerHTML)}},e={attach:function(t,e){let n="attach-"+t;this[n]&&this[n](e),this.attachGoBack()},"attach-menu":function(){log("[Events] Attaching Menu events"),a("[data-menu]","click",function(t){o(t.currentTarget.dataset.menu)})},"attach-share":function(){log("[Events] Attaching Share events");let t=null;a('[name="timeout"]',"keyup",function e(n){clearTimeout(t);let r=p("js-expires-on"),o=n.target.value;o.trim()?(r.innerText=`Expires on: ${i.getExpirationString(o)}`,t=setTimeout(function(){e(n)},1e3)):r.innerText=""}),a("#js-share-session","submit",function(){try{let t=u(this,"pubkey").value,e=u(this,"timeout").value,r=i.getExpirationTime(e);n.store(t,r,function(t,e){g("js-shared-session"),p("js-shared-session-text").innerHTML=t,function(t){shareText.getLink(t,function(t){p("js-share-text-link").innerHTML=t,g("js-share-text-actions"),window.scrollBy({top:500,left:0,behavior:"smooth"})},function(){p("js-share-text-link").innerHTML="Whops, couldn't get the link"})}(t)})}catch(t){console.warn(t),c("An error occurred trying to encrypt your session. Check that the code is correct.")}}),a("#js-session-hide","click",()=>f("js-shared-session")),a("#js-copy-share-text","click",()=>f("js-shared-session")),this.onTextSubmitted('[name="pubkey"]',function(t){const e=document.querySelector('input[name="submit"]');h(t.value,e)})},"attach-restore":function(){log("[Events] Attaching Restore events"),a("#js-regenerate-keys","click",function(t){const{publicKey:e}=r.generate();n.removeAll(),p("js-user-pubkey").value=e,d(t.currentTarget,"data-balloon","Restored!")}),a("#js-restore-session","submit",function(t){try{let e=u(t.currentTarget,"encrypted-data");n.restore(e.value),t.currentTarget.reset()}catch(t){console.warn(t),c("An error occurred trying to restore the session. Check that the encrypted text is correct and was generated with your code.")}}),this.onTextSubmitted('[name="encrypted-data"]',function(t){const e=document.querySelector('input[name="submit"]');h(t.value,e);let r="";try{const{title:e,expirationTime:o}=n.decrypt(t.value);r=`Restore "${e}" session.`,i.isExpired(o)&&(r+="\nThe session seems to be expired!")}catch(t){r="",console.warn(t)}p("js-restore-notice").innerText=r})},"attach-history":function(){log("[Events] Attaching History events"),a(".js-delete","click",function(t){let e=t.currentTarget.dataset.key;n.remove(e,()=>o("history"))})},attachClipboard:function(){log("[Events] Attaching clipboard"),new Clipboard("[data-clipboard]").on("success",function(t){d(t.trigger,"data-balloon","Copied!"),t.clearSelection()})},attachGoBack:function(){log("[Events] Attaching go back"),a(".js-go-back","click",()=>t.render("menu"))},onTextSubmitted:function(t,e){a(t,"keyup",t=>{e(t.currentTarget)}),a(t,"paste",t=>{const n=t.clipboardData.getData("Text");window.document.execCommand("insertText",!1,n),e(t.currentTarget)})}},n={store:function(t,e,i){this.getCurrent(function(o,s){let c={url:o.url,title:o.title,cookies:cookieManager.setExpirationDate(s,e),expirationTime:e};const a=r.encrypt(t,c);n.record(o.url,o.title),i(a,o)})},getCurrent(t){s(function(e){cookieManager.get(e.url,function(n){return t(e,n)})})},record:function(t,e){n.modify(function(r){let i=new Date,o=n.getKey(i);return r[o]=r[o]||[],r[o].push({url:t,title:e,timestamp:i.getTime()}),n.filterOlderKeys(r)})},restore:function(t){const{url:e,cookies:n}=this.decrypt(t);cookieManager.set(e,n),chrome.tabs.create({url:e})},decrypt:t=>r.decrypt(t),removeAll:function(t){n.modify(function(){return{}})},remove:function(t,e){n.modify(function(e){return delete e[t],e},e)},modify:function(t,e){configuration.get("sessions",function(n){var r;n=t(n),configuration.set({sessions:n,hasSessions:(r=n,!(0===Object.keys(r).length))}),e&&e()})},getKey:function(t){return[t.getMonth(),t.getDate(),t.getYear()].join("/")},filterOlderKeys:function(t){let e=(new Date).getMonth(),n={};for(let r in t){e==this.getMonthFromKey(r)&&(n[r]=t[r])}return n},getMonthFromKey:function(t){return t.split("/")[0]}},r={pair:{publicKey:null,privateKey:null},upsert:function(){this.isGenerated()||configuration.get(this.pair,function(t,e){t&&e?this.pair={publicKey:t,privateKey:e}:this.generate()}.bind(this))},generate:function(){log("Saving user keys for later signing");const t=cryptography.createKeys();return this.pair=t,configuration.set(t),this.pair},isGenerated:function(){return this.publicKey&&this.privateKey},encrypt:function(t,e){const n=cryptography.decodePublicKey(t);return cryptography.encrypt(n,JSON.stringify(e))},decrypt:function(t){const e=cryptography.decodePrivateKey(this.pair.privateKey),n=cryptography.decrypt(e,t);return JSON.parse(n)}},i={DEFAULT:168,getExpirationTime(t){return t=this.isValidTimeout(t)?t:this.DEFAULT,Date.now()+this.hoursToMs(t)},getExpirationString(t){const e=this.getExpirationTime(t);return new Date(e).toLocaleString()},isExpired:t=>Date.now()>=t,isValidTimeout:t=>parseInt(t,10)>0,hoursToMs:t=>60*t*60*1e3};function o(e){s(n=>configuration.get(r=>t.render(e,Object.assign({tab:n},r))))}function s(t){chrome.tabs.query({active:!0,currentWindow:!0},function(e){t(e[0])})}function c(t){let e=p("js-error");e.innerHTML=t,d(e,"className","error",4500)}function a(t,e,n){let r=document.querySelectorAll(t);r.length||log("[WARN] Could not find an element for selector "+t);for(let t=0;t<r.length;t++)r[t].addEventListener(e,l(n),!1)}function u(t,e){let n=t.elements;for(let t=0;t<n.length;t++)if(n[t].name===e)return n[t]}function l(t){return function(e){e.preventDefault(),t.call(this,e)}}function h(t,e){t.trim()?e.removeAttribute("disabled",!1):e.setAttribute("disabled",!1)}function d(t,e,n,r){const i=function(n){void 0===t[e]?t.setAttribute(e,n):t[e]=n};let o=t[e]||t.getAttribute(e);i(n),setTimeout(()=>i(o),r||1e3)}function g(t){let e=p(t);return e.classList.remove("hidden"),e}function f(t){let e=p(t);return e.classList.add("hidden"),e}function p(t){return document.getElementById(t)}r.upsert(),t.render("menu"),e.attachClipboard()}();